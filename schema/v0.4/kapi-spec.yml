#    KAPI API Specification
#    Copyright (C) 2021 Elizabeth Paige Harper
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <https://www.gnu.org/licenses/>.

$schema: https://json-schema.org/draft-07/schema

oneOf:
- $ref: "#/definitions/document-api"
- $ref: "#/definitions/document-library"


definitions:

  # +----------------------------------------------------------------------+ #
  # |                                                                      | #
  # |   Document Types                                                     | #
  # |                                                                      | #
  # +----------------------------------------------------------------------+ #

  document-api:
    type: object
    properties:
      kapi:
        $ref: "#/definitions/kapi-version"
      type:
        type: string
        enum:
        - api
      info: {}
      imports: {}
      routes: {}
      components: {}
    required:
    - kapi
    - type
    - info
    additionalProperties: false

  document-library:
    type: object
    properties:
      kapi:
        $ref: "#/definitions/kapi-version"
      type:
        type: string
        enum:
        - library
      components: {}
    required:
    - kapi
    - type
    - components
    additionalProperties: false


  # +----------------------------------------------------------------------+ #
  # |                                                                      | #
  # |   Document Fields                                                    | #
  # |                                                                      | #
  # +----------------------------------------------------------------------+ #

  kapi-version:
    title: KAPI Version
    type: string
    enum:
    - v0.4


  # +----------------------------------------------------------------------+ #
  # |                                                                      | #
  # |   Type Definitions                                                   | #
  # |                                                                      | #
  # +----------------------------------------------------------------------+ #

  type-definition:
    allOf:
    - $ref: "#/definitions/type-base-props"
    - $ref: "#/definitions/type-def-base-props"
    - oneOf:


  type-def-base-props:
    type: object
    properties:
      name:
        $ref: "#/definitions/type-name"
    required:
    - name


  # +----------------------------------------------------------------------+ #
  # |                                                                      | #
  # |   Type Referencing                                                   | #
  # |                                                                      | #
  # +----------------------------------------------------------------------+ #

  type-reference: { }

  # +----------------------------------------------------------------------+ #
  # |   Inline Type References                                             | #
  # +----------------------------------------------------------------------+ #

  type-ref-inline:
    type: string
    pattern: ^(?:(?:array|list|set)\[(?:\w[\w\d]*\??)\]\??|map\[(?:\w[\w\d]*), ?(?:\w[\w\d]*\??)\]\??|\w[\w\d]*\??)$

  # +----------------------------------------------------------------------+ #
  # |   Expanded Type References                                           | #
  # +----------------------------------------------------------------------+ #

  type-ref-expanded:
    allOf:
    - $ref: "#/definitions/type-base-props"
    - $ref: "#/definitions/type-ref-e-base-props"
    - oneOf:
      - $ref: "#/definitions/type-ref-e-boolean"
      - $ref: "#/definitions/type-ref-e-date"
      - $ref: "#/definitions/type-ref-e-decimal"
      - $ref: "#/definitions/type-ref-e-integer"
      - $ref: "#/definitions/type-ref-e-list"
      - $ref: "#/definitions/type-ref-e-map"
      - $ref: "#/definitions/type-ref-e-set"
      - $ref: "#/definitions/type-ref-e-string"

  type-ref-e-base-props:
    type: object
    properties:
      nullable:
        type: boolean
        default: false

  type-ref-e-boolean:
    type: object
    properties:
      type:
        enum: [ boolean ]
      default:
        type: boolean
      const:
        type: boolean
      example:
        type: boolean

  type-ref-e-date: { }

  type-ref-e-decimal:
    type: object
    properties:
      type:
        enum: [ decimal ]
      default:
        type: number
      const:
        type: number
      example:
        type: number

  type-ref-e-integer: { }

  type-ref-e-list: { }

  type-ref-e-map: { }

  type-ref-e-set: { }

  type-ref-e-string: { }

  # +----------------------------------------------------------------------+ #
  # |                                                                      | #
  # |   Type Meta                                                          | #
  # |                                                                      | #
  # +----------------------------------------------------------------------+ #

  # +----------------------------------------------------------------------+ #
  # |   Type Enums                                                         | #
  # +----------------------------------------------------------------------+ #

  kapi-types:
    enum:
    - array
    - boolean
    - date
    - decimal
    - enum
    - integer
    - list
    - map
    - object
    - set
    - string

  types-simple:
    enum:
    - boolean
    - date
    - decimal
    - integer
    - string

  types-complex:
    enum:
    - array
    - enum
    - list
    - map
    - object
    - set

  # +----------------------------------------------------------------------+ #
  # |   Type Basics                                                        | #
  # +----------------------------------------------------------------------+ #

  type-name:
    type: string
    pattern: ^\w[\w\d]*$

  type-base-props:
    description: |
      Properties common to all type definitions or expanded type references.
    type: object
    properties:
      summary:
        title: Type Summary
        description: Short description of the type being defined.
        type: string
      description:
        title: Type Description
        description: Long description or help text for the type being defined.
        type: string
    required:
    - type

  type-string-props:
    description: |
      Properties common to all string type definitions or expanded string type
      references.
    type: object
    properties:
      type:
        enum: [ string ]
      minLength:
        type: integer
        minimum: 0
        default: 0
      maxLength:
        type: integer
        minimum: 0
      pattern:
        type: string
        format: regex
    required:
    - type
